// قواعد أمان Firestore لمشروع kuwaity-farm
// لتقييد قراءة المواضيع العامة للمستخدمين المسجلين فقط، غيّر `resource.data.isPublic == true`
// إلى `request.auth != null && resource.data.isPublic == true` في القاعدة أدناه.
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // القاعدة الخاصة بمواضيع المستخدمين
    match /users/{userId}/topics/{topicId} {
      // السماح بالقراءة:
      // 1. إذا كان الموضوع عامًا (isPublic == true).
      // 2. أو إذا كان المستخدم هو مالك الموضوع.
      allow read: if resource.data.isPublic == true || (request.auth != null && request.auth.uid == userId);

      // السماح بالإنشاء:
      // 1. يجب أن يكون المستخدم مسجلاً للدخول.
      // 2. يجب أن يكون userId في المستند الجديد مطابقًا لـ uid الخاص بالمستخدم.
      // 3. يجب أن يكون العنوان نصيًا وأطول من حرف واحد.
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId
                    && request.resource.data.title is string
                    && request.resource.data.title.size() > 1;

      // السماح بالتحديث والحذف فقط لمالك الموضوع.
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // قاعدة خاصة ومهمة لدعم استعلام collectionGroup على 'topics'
    // هذه القاعدة تسمح فقط بقراءة المواضيع التي تحمل علامة 'isPublic'
    match /{path=**}/topics/{topicId} {
        allow read: if resource.data.isPublic == true;
    }
    
    // يمكنك إضافة قواعد لمجموعات أخرى هنا
    // match /posts/{postId} { ... }
  }
}
