rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin privileges
    function isAdmin() {
      // The adminUids array is hardcoded here from lib/firebase.ts
      let adminUids = ['JU2IAJu8XEeCqM33bu1wzlrA7id2'];
      return request.auth.uid in adminUids;
    }
    
    // Allow admins to create notifications at the root level
    match /notifications/{notificationId} {
      allow create: if isAdmin();
    }

    // Rules for user-specific data, including their own documents
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth.uid == userId;
    }

    // Rules for reading public topics via collectionGroup query
    match /{path=**}/topics/{topicId} {
       allow read: if resource.data.isPublic == true;
    }

    // Rules for reading notifications via collectionGroup query
    match /{path=**}/notifications/{notificationId} {
      allow read: if request.auth != null && 
                     (resource.data.target == 'all' || resource.data.target == request.auth.uid);
    }
  }
}
