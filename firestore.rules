// --- FILE: firestore.rules ---
// هذه القواعد تهدف إلى تأمين قاعدة بيانات Firestore الخاصة بك.
// لتغيير قواعد القراءة من "عامة" إلى "مقيدة للمسجلين فقط"،
// استبدل `allow read: if true;` بـ `allow read: if request.auth != null;`

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- قواعد مجموعة المواضيع العامة (Posts) ---
    // هذه المجموعة متاحة للقراءة من قبل أي شخص، ولكن لا يمكن إنشاؤها أو تعديلها
    // إلا من قبل المستخدمين المسجلين والمصرح لهم.
    match /posts/{postId} {
      // القراءة عامة للجميع.
      allow read: if true;
      
      // الإنشاء مسموح فقط للمستخدمين المسجلين، بشرط أن يكون `userId`
      // في المستند الجديد مطابقًا لمعرف المستخدم الذي أرسل الطلب.
      // كما يتم التحقق من أن العنوان موجود وهو نص.
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid
                    && 'title' in request.resource.data && request.resource.data.title is string
                    && request.resource.data.title.size() > 1;
                    
      // التحديث والحذف مسموحان فقط لمالك المنشور.
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // --- قواعد المجموعات الخاصة بالمستخدمين (Topics) ---
    // هذه القواعد تضمن أن كل مستخدم لديه سيطرة كاملة على بياناته الخاصة
    // داخل المسار `users/{uid}`، ولا يمكن لأي مستخدم آخر الوصول إليها.
    match /users/{uid}/{documents=**} {
      // السماح للمستخدم مالك `uid` فقط بقراءة، كتابة، تعديل، وحذف
      // أي مستندات داخل مجلده الخاص.
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
  }
}
// --- END FILE ---