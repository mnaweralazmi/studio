// قواعد أمان Firestore لمشروع kuwaity-farm
// هذه القواعد تضمن عزل بيانات المستخدم والسماح بعرض المواضيع العامة بشكل آمن.

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // القاعدة الخاصة بمواضيع المستخدمين
    // كل مستخدم يملك مواضيعه الخاصة داخل users/<uid>/topics/<topicId>
    match /users/{userId}/topics/{topicId} {
      
      // شروط القراءة:
      // 1. يمكن لأي شخص قراءة الموضوع إذا كان عامًا (isPublic == true).
      // 2. يمكن للمستخدم مالك الموضوع قراءته دائمًا، حتى لو كان خاصًا.
      allow read: if resource.data.isPublic == true || request.auth.uid == userId;

      // شروط الإنشاء:
      // 1. يجب أن يكون المستخدم مسجلاً.
      // 2. يجب أن يكون userId في المستند الجديد مطابقًا لمعرف المستخدم الذي يقوم بالعملية.
      // 3. يجب أن يكون العنوان نصًا وأطول من حرف واحد.
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId
                    && request.resource.data.title is string
                    && request.resource.data.title.size() > 1;

      // شروط التحديث والحذف:
      // فقط مالك الموضوع يمكنه تعديله أو حذفه.
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
  }
}
