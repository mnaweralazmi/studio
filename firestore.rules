
// هذه القواعد تهدف إلى تأمين الوصول إلى قاعدة بيانات Firestore.
// القاعدة الأساسية هي منع الوصول افتراضيًا والسماح به فقط عند الحاجة.
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // القاعدة الخاصة باستعلام collectionGroup على مجموعة 'topics'
    // هذه القاعدة ضرورية لتمكين جلب جميع المواضيع العامة من جميع المستخدمين.
    match /{path=**}/topics/{topicId} {
      // السماح بالقراءة فقط إذا كان الموضوع عامًا.
      allow read: if resource.data.isPublic == true;
    }

    // قواعد خاصة بمجموعة مواضيع كل مستخدم على حدة
    match /users/{userId}/topics/{topicId} {
      // 1. السماح بالقراءة إذا كان الموضوع عامًا أو إذا كان المستخدم هو المالك.
      allow read: if resource.data.isPublic == true || (request.auth != null && request.auth.uid == userId);

      // 2. السماح بالإنشاء فقط للمستخدمين المسجلين، بشرط أن يكونوا مالكي المستند
      // ويجب أن يحتوي على حقل عنوان نصي غير فارغ.
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.title is string
                    && request.resource.data.title.size() > 1;
      
      // 3. السماح بالتحديث والحذف فقط لمالك المستند.
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // أي مسارات أخرى لم يتم تحديدها هنا ستكون ممنوعة بشكل افتراضي.
  }
}
