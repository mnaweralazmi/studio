// لتقييد القراءة للمستخدمين المسجلين فقط، غيّر `allow read` إلى: `if request.auth != null;`
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // القاعدة الرئيسية: تمنع الوصول لأي مستند بشكل افتراضي
    match /{document=**} {
      allow read, write: if false;
    }

    // قاعدة تسمح بقراءة مجموعة "topics" إذا كانت عامة
    match /{path=**}/topics/{topicId} {
      allow read: if resource.data.isPublic == true;
    }

    // قواعد الوصول لمستندات المستخدمين
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // قواعد لمجموعة "topics" الفرعية
      match /topics/{topicId} {
        // يمكن للمستخدم قراءة مواضيعه الخاصة
        // يمكن للجميع قراءة المواضيع العامة (مغطاة بالقاعدة أعلاه لكن هذه للتوضيح)
        allow read: if (request.auth != null && request.auth.uid == userId) || resource.data.isPublic == true;

        // يمكن للمستخدم إنشاء موضوع إذا كان مسجلاً ويملك المستند
        allow create: if request.auth != null && request.auth.uid == userId
                      && request.resource.data.userId == userId // تأكيد أن userId في المستند هو نفسه
                      && request.resource.data.title is string
                      && request.resource.data.title.size() > 0;

        // يمكن للمستخدم تحديث أو حذف مواضيعه الخاصة فقط
        allow update, delete: if request.auth != null && request.auth.uid == userId;
      }
      
      // يمكنك إضافة قواعد للمجموعات الفرعية الأخرى هنا
      // مثال:
      // match /tasks/{taskId} {
      //   allow read, write: if request.auth != null && request.auth.uid == userId;
      // }
    }
  }
}
