rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Global Collections ---

    // Public topics can be read by any authenticated user.
    // Only admins can create, update, or delete them.
    match /publicTopics/{topicId} {
      allow read: if request.auth != null;
      allow write, delete: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/siteContent/admins).data.uids;
    }

    // Site content (like admin list and marquee ads) can be read and written only by admins.
    match /siteContent/{docId} {
      allow read, write: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/siteContent/admins).data.uids;
    }

    // Notifications can be created by admins.
    // They can be read by the user if they are the target or if the notification is for 'all'.
    match /notifications/{notificationId} {
       allow read: if request.auth != null && 
                      (resource.data.target == 'all' || 
                       request.auth.uid == resource.data.target || 
                       ('admin' in resource.data.target && request.auth.uid in get(/databases/$(database)/documents/siteContent/admins).data.uids));
       allow create: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/siteContent/admins).data.uids;
    }
    
    // --- User-Specific Data ---

    // A user can read, write, update, and delete any document within their own user directory.
    // This rule is broad to allow for collection group queries needed for stats and other features,
    // while still securing data to the authenticated user.
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
