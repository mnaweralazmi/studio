<!doctype html>
<html lang="ar" dir="rtl">
<meta charset="utf-8" />
<title>Ø¨ÙŠØ§Ù†Ø§ØªÙŠ Ù…Ù† Firebase (Ø¥ØµÙ„Ø§Ø­ ØªØ·Ø§Ø¨Ù‚ UID/Email)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<body style="font-family:Segoe UI,Tajawal,system-ui,-apple-system;max-width:900px;margin:24px auto;padding:0 14px;line-height:1.7;background:#0b1220;color:#e8eefc">

  <h2 style="margin:8px 0 18px">ğŸ“Š Ø¨ÙŠØ§Ù†Ø§ØªÙŠ Ù…Ù† Firebase</h2>

  <!-- Ø´Ø±ÙŠØ· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬ -->
  <div style="display:flex;gap:10px;align-items:center;margin:12px 0 6px">
    <button id="loginBtn" style="padding:8px 12px;border:0;border-radius:8px;background:#4f7dff;color:#fff;cursor:pointer">
      ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google (Popup â‡¢ Redirect ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ù†Ø¹)
    </button>
    <button id="logoutBtn" style="display:none;padding:8px 12px;border:0;border-radius:8px;background:#e34; color:#fff;cursor:pointer">
      Ø®Ø±ÙˆØ¬
    </button>
    <span>Ø§Ù„Ø­Ø§Ù„Ø©: <b id="status">ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„</b></span>
  </div>

  <!-- Ø¯Ø®ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯/ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (Ù„Ù…Ù†Ø¹ Ø§Ù„Ù†ÙˆØ§ÙØ°) -->
  <details style="margin:8px 0 18px">
    <summary style="cursor:pointer">Ø¨Ø¯ÙŠÙ„: Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯/ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</summary>
    <div style="background:#0f1b36;border:1px solid #233766;border-radius:10px;padding:10px;margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯:
        <input id="email" type="email" style="padding:6px;border-radius:8px;border:1px solid #2c457a;background:#0b1734;color:#e8eefc;width:260px">
      </label>
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:
        <input id="pass" type="password" style="padding:6px;border-radius:8px;border:1px solid #2c457a;background:#0b1734;color:#e8eefc;width:200px">
      </label>
      <button id="signin" style="padding:8px 12px;border:0;border-radius:8px;background:#3aa675;color:#fff;cursor:pointer">Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
    </div>
  </details>

  <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
  <h3 style="margin:16px 0 8px">ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
  <pre id="me" style="background:#0f1b36;border:1px solid #233766;border-radius:10px;padding:12px;white-space:pre-wrap">â€”</pre>

  <!-- Ø§Ù„Ø¯ÙŠÙˆÙ† -->
  <h3 style="margin:16px 0 8px">ğŸ’³ Ø§Ù„Ø¯ÙŠÙˆÙ†</h3>
  <ul id="debtsList" style="list-style:none;padding:0;margin:0;background:#0f1b36;border:1px solid #233766;border-radius:10px">
    <li style="padding:12px;border-bottom:1px solid #233766;color:#9fb9ff">(Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯)</li>
  </ul>

  <!-- Ø§Ù„Ø³Ø¬Ù„ -->
  <h3 style="margin:16px 0 8px">Ø§Ù„Ø³Ø¬Ù„ (Ù„Ù„ØªØ´Ø®ÙŠØµ)</h3>
  <pre id="log" style="background:#081328;border:1px solid #1a2b56;border-radius:10px;padding:12px;white-space:pre-wrap">(Ø¬Ø§Ù‡Ø²)</pre>

  <script type="module">
    /* ===== Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø­Ø²Ù… Firebase (CDN) ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider,
      signInWithPopup, signInWithRedirect, getRedirectResult,
      onAuthStateChanged, signOut,
      signInWithEmailAndPassword, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, onSnapshot, query, where, getDocs, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyCLB7Dfw5jpDQsVvep-OWVeNv9Hq_nQZSs",
      authDomain: "kuwaity-farm.firebaseapp.com",
      projectId: "kuwaity-farm",
      storageBucket: "kuwaity-farm.firebasestorage.app",
      messagingSenderId: "433160071015",
      appId: "1:433160071015:web:5d271b172d739b16ddb1c2"
    };

    /* ===== ØªÙ‡ÙŠØ¦Ø© Firebase ===== */
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence).catch(()=>{});

    /* ===== Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===== */
    const statusEl   = document.getElementById('status');
    const loginBtn   = document.getElementById('loginBtn');
    const logoutBtn  = document.getElementById('logoutBtn');
    const meBox      = document.getElementById('me');
    const debtsList  = document.getElementById('debtsList');
    const logEl      = document.getElementById('log');

    const emailEl = document.getElementById('email');
    const passEl  = document.getElementById('pass');
    const signinEl= document.getElementById('signin');

    const log = (...a)=>{ console.log(...a); logEl.textContent += "\n" + a.join(" "); };

    /* ===== Ø¯Ø®ÙˆÙ„ Google: Popup Ù…Ø¹ fallback Ø¥Ù„Ù‰ Redirect ===== */
    const provider = new GoogleAuthProvider();
    loginBtn.onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
        log("Popup OK");
      } catch (e) {
        if (e && e.code === "auth/popup-blocked") {
          log("Popup blocked -> using Redirect");
          await signInWithRedirect(auth, provider);
        } else if (e && e.code === "auth/popup-closed-by-user") {
          log("Popup closed by user");
        } else {
          log("Popup error:", e.code || e.message);
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + (e.code || e.message));
        }
      }
    };

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù€ Redirect (Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
    getRedirectResult(auth).then(res=>{
      if (res && res.user) log("Redirect OK:", res.user.email || res.user.uid);
    }).catch(err=>{
      if (err) log("Redirect error:", err.code || err.message);
    });

    /* ===== Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯/ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ===== */
    signinEl.onclick = async () => {
      try {
        const res = await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
        log("Email sign-in OK:", res.user.email);
      } catch (e) {
        log("Email sign-in error:", e.code || e.message);
        alert("ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + (e.code || e.message));
      }
    };

    /* ===== Ø¹Ù†Ø¯ ØªØºÙŠÙ‘Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        statusEl.textContent = "ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„";
        logoutBtn.style.display = "none";
        meBox.textContent = "â€”";
        debtsList.innerHTML = `<li style="padding:12px;border-bottom:1px solid #233766;color:#9fb9ff">(Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯)</li>`;
        return;
      }
      statusEl.textContent = "Ù…Ø³Ø¬Ù‘Ù„: " + (user.email || user.uid);
      logoutBtn.style.display = "inline-block";
      await loadUserDataFlexible(user);
    });

    logoutBtn.onclick = ()=> signOut(auth);

    /* ===== Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø±Ù†Ø©: by uid Ø«Ù… email ===== */
    async function loadUserDataFlexible(user) {
      try {
        // 1) Ø¬Ø±Ù‘Ø¨ Ø¨ÙˆØ«ÙŠÙ‚Ø© uid Ù…Ø¨Ø§Ø´Ø±Ø©
        let docId = user.uid;
        let snap = await getDoc(doc(db, "users", docId));

        // 2) Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯ØŒ Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ (email == user.email)
        if (!snap.exists() && user.email) {
          const q = query(collection(db, "users"), where("email", "==", user.email));
          const qs = await getDocs(q);
          if (!qs.empty) {
            const hit = qs.docs[0];
            docId = hit.id;   // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù€ docId Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙØ¹Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ
            snap  = hit;
            log("Found user doc by email â‡’ docId:", docId);
          } else {
            log("No doc found by uid nor by email");
          }
        }

        // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (snap.exists()) {
          const d = snap.data();
          meBox.textContent = JSON.stringify(d, null, 2);
        } else {
          meBox.textContent = "(Ù„Ù… Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ ÙˆØ«ÙŠÙ‚Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ Ø¨Ø§Ù„Ù€ UID ÙˆÙ„Ø§ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯)";
          debtsList.innerHTML = `<li style="padding:12px;border-bottom:1px solid #233766;color:#9fb9ff">(Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ†)</li>`;
          return;
        }

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¯ÙŠÙˆÙ† ØªØ­Øª docId Ø§Ù„Ø°ÙŠ ÙˆØ¬Ø¯Ù†Ø§Ù‡
        const qDebts = query(
          collection(db, "users", docId, "debts"),
          orderBy("createdAt", "desc")
        );
        onSnapshot(qDebts, (qs) => {
          const items = [];
          qs.forEach(d => items.push({ id: d.id, ...d.data() }));
          if (!items.length) {
            debtsList.innerHTML = `<li style="padding:12px;border-bottom:1px solid #233766;color:#9fb9ff">(Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ†)</li>`;
            return;
          }
          debtsList.innerHTML = "";
          for (const it of items) {
            const li = document.createElement("li");
            li.style.padding = "12px";
            li.style.borderBottom = "1px solid #233766";
            li.innerHTML = `
              Ø§Ù„Ø¯Ø§Ø¦Ù†: <b>${escapeHTML(it.creditor ?? "â€”")}</b> Â·
              Ø§Ù„Ù…Ø¨Ù„Øº: <b>${escapeHTML(it.amount ?? "â€”")}</b> Â·
              Ø§Ù„Ø­Ø§Ù„Ø©: <b>${escapeHTML(it.status ?? "â€”")}</b>
            `;
            debtsList.appendChild(li);
          }
        }, (err) => {
          debtsList.innerHTML = `<li style="padding:12px;border-bottom:1px solid #233766;color:#faa">debts listen error: ${escapeHTML(err.message||err)}</li>`;
        });

      } catch (e) {
        log("loadUserDataFlexible error:", e.code || e.message);
        alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + (e.code || e.message));
      }
    }

    /* ===== Ù…Ø³Ø§Ø¹Ø¯ ØµØºÙŠØ± Ù„Ù…Ù†Ø¹ Ø¥Ø¯Ø®Ø§Ù„ HTML ÙÙŠ Ø§Ù„Ù†ØµÙˆØµ ===== */
    function escapeHTML(s){
      s = (s ?? "").toString();
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /* ØªØ´Ø®ÙŠØµ Ø³Ø±ÙŠØ¹ */
    log("origin:", location.origin, "\nauthDomain:", firebaseConfig.authDomain);
  </script>
</body>
</html>
