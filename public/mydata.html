<!doctype html>
<html lang="ar" dir="rtl">
<meta charset="utf-8" />
<title>بياناتي من Firebase (إصلاح تطابق UID/Email)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<body style="font-family:Segoe UI,Tajawal,system-ui,-apple-system;max-width:900px;margin:24px auto;padding:0 14px;line-height:1.7;background:#0b1220;color:#e8eefc">

  <h2 style="margin:8px 0 18px">📊 بياناتي من Firebase</h2>

  <!-- شريط أزرار الدخول/الخروج -->
  <div style="display:flex;gap:10px;align-items:center;margin:12px 0 6px">
    <button id="loginBtn" style="padding:8px 12px;border:0;border-radius:8px;background:#4f7dff;color:#fff;cursor:pointer">
      تسجيل الدخول بحساب Google (Popup ⇢ Redirect تلقائيًا عند المنع)
    </button>
    <button id="logoutBtn" style="display:none;padding:8px 12px;border:0;border-radius:8px;background:#e34; color:#fff;cursor:pointer">
      خروج
    </button>
    <span>الحالة: <b id="status">غير مسجّل</b></span>
  </div>

  <!-- دخول اختياري بالبريد/كلمة مرور (لمنع النوافذ) -->
  <details style="margin:8px 0 18px">
    <summary style="cursor:pointer">بديل: دخول بالبريد/كلمة مرور (اختياري)</summary>
    <div style="background:#0f1b36;border:1px solid #233766;border-radius:10px;padding:10px;margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <label>البريد:
        <input id="email" type="email" style="padding:6px;border-radius:8px;border:1px solid #2c457a;background:#0b1734;color:#e8eefc;width:260px">
      </label>
      <label>كلمة المرور:
        <input id="pass" type="password" style="padding:6px;border-radius:8px;border:1px solid #2c457a;background:#0b1734;color:#e8eefc;width:200px">
      </label>
      <button id="signin" style="padding:8px 12px;border:0;border-radius:8px;background:#3aa675;color:#fff;cursor:pointer">دخول بالبريد</button>
    </div>
  </details>

  <!-- معلومات المستخدم -->
  <h3 style="margin:16px 0 8px">👤 معلومات المستخدم</h3>
  <pre id="me" style="background:#0f1b36;border:1px solid #233766;border-radius:10px;padding:12px;white-space:pre-wrap">—</pre>

  <!-- الديون -->
  <h3 style="margin:16px 0 8px">💳 الديون</h3>
  <ul id="debtsList" style="list-style:none;padding:0;margin:0;background:#0f1b36;border:1px solid #233766;border-radius:10px">
    <li style="padding:12px;border-bottom:1px solid #233766;color:#9fb9ff">(لا توجد بيانات بعد)</li>
  </ul>

  <!-- السجل -->
  <h3 style="margin:16px 0 8px">السجل (للتشخيص)</h3>
  <pre id="log" style="background:#081328;border:1px solid #1a2b56;border-radius:10px;padding:12px;white-space:pre-wrap">(جاهز)</pre>

  <script type="module">
    /* ===== استيراد حزم Firebase (CDN) ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider,
      signInWithPopup, signInWithRedirect, getRedirectResult,
      onAuthStateChanged, signOut,
      signInWithEmailAndPassword, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, onSnapshot, query, where, getDocs, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ===== إعدادات مشروعك ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyCLB7Dfw5jpDQsVvep-OWVeNv9Hq_nQZSs",
      authDomain: "kuwaity-farm.firebaseapp.com",
      projectId: "kuwaity-farm",
      storageBucket: "kuwaity-farm.firebasestorage.app",
      messagingSenderId: "433160071015",
      appId: "1:433160071015:web:5d271b172d739b16ddb1c2"
    };

    /* ===== تهيئة Firebase ===== */
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence).catch(()=>{});

    /* ===== عناصر واجهة المستخدم ===== */
    const statusEl   = document.getElementById('status');
    const loginBtn   = document.getElementById('loginBtn');
    const logoutBtn  = document.getElementById('logoutBtn');
    const meBox      = document.getElementById('me');
    const debtsList  = document.getElementById('debtsList');
    const logEl      = document.getElementById('log');

    const emailEl = document.getElementById('email');
    const passEl  = document.getElementById('pass');
    const signinEl= document.getElementById('signin');

    const log = (...a)=>{ console.log(...a); logEl.textContent += "\n" + a.join(" "); };

    /* ===== دخول Google: Popup مع fallback إلى Redirect ===== */
    const provider = new GoogleAuthProvider();
    loginBtn.onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
        log("Popup OK");
      } catch (e) {
        if (e && e.code === "auth/popup-blocked") {
          log("Popup blocked -> using Redirect");
          await signInWithRedirect(auth, provider);
        } else if (e && e.code === "auth/popup-closed-by-user") {
          log("Popup closed by user");
        } else {
          log("Popup error:", e.code || e.message);
          alert("خطأ في الدخول: " + (e.code || e.message));
        }
      }
    };

    // معالجة نتيجة الـ Redirect (إن وُجدت)
    getRedirectResult(auth).then(res=>{
      if (res && res.user) log("Redirect OK:", res.user.email || res.user.uid);
    }).catch(err=>{
      if (err) log("Redirect error:", err.code || err.message);
    });

    /* ===== دخول بالبريد/كلمة مرور (اختياري) ===== */
    signinEl.onclick = async () => {
      try {
        const res = await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
        log("Email sign-in OK:", res.user.email);
      } catch (e) {
        log("Email sign-in error:", e.code || e.message);
        alert("فشل الدخول: " + (e.code || e.message));
      }
    };

    /* ===== عند تغيّر حالة المصادقة ===== */
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        statusEl.textContent = "غير مسجّل";
        logoutBtn.style.display = "none";
        meBox.textContent = "—";
        debtsList.innerHTML = `<li style="padding:12px;border-bottom:1px solid #233766;color:#9fb9ff">(لا توجد بيانات بعد)</li>`;
        return;
      }
      statusEl.textContent = "مسجّل: " + (user.email || user.uid);
      logoutBtn.style.display = "inline-block";
      await loadUserDataFlexible(user);
    });

    logoutBtn.onclick = ()=> signOut(auth);

    /* ===== القراءة المرنة: by uid ثم email ===== */
    async function loadUserDataFlexible(user) {
      try {
        // 1) جرّب بوثيقة uid مباشرة
        let docId = user.uid;
        let snap = await getDoc(doc(db, "users", docId));

        // 2) إن لم توجد، ابحث بالبريد (email == user.email)
        if (!snap.exists() && user.email) {
          const q = query(collection(db, "users"), where("email", "==", user.email));
          const qs = await getDocs(q);
          if (!qs.empty) {
            const hit = qs.docs[0];
            docId = hit.id;   // استخدم الـ docId الموجود فعليًا في بياناتك
            snap  = hit;
            log("Found user doc by email ⇒ docId:", docId);
          } else {
            log("No doc found by uid nor by email");
          }
        }

        // عرض بيانات المستخدم
        if (snap.exists()) {
          const d = snap.data();
          meBox.textContent = JSON.stringify(d, null, 2);
        } else {
          meBox.textContent = "(لم نعثر على وثيقة مستخدم لا بالـ UID ولا بالبريد)";
          debtsList.innerHTML = `<li style="padding:12px;border-bottom:1px solid #233766;color:#9fb9ff">(لا توجد ديون)</li>`;
          return;
        }

        // الاستماع للديون تحت docId الذي وجدناه
        const qDebts = query(
          collection(db, "users", docId, "debts"),
          orderBy("createdAt", "desc")
        );
        onSnapshot(qDebts, (qs) => {
          const items = [];
          qs.forEach(d => items.push({ id: d.id, ...d.data() }));
          if (!items.length) {
            debtsList.innerHTML = `<li style="padding:12px;border-bottom:1px solid #233766;color:#9fb9ff">(لا توجد ديون)</li>`;
            return;
          }
          debtsList.innerHTML = "";
          for (const it of items) {
            const li = document.createElement("li");
            li.style.padding = "12px";
            li.style.borderBottom = "1px solid #233766";
            li.innerHTML = `
              الدائن: <b>${escapeHTML(it.creditor ?? "—")}</b> ·
              المبلغ: <b>${escapeHTML(it.amount ?? "—")}</b> ·
              الحالة: <b>${escapeHTML(it.status ?? "—")}</b>
            `;
            debtsList.appendChild(li);
          }
        }, (err) => {
          debtsList.innerHTML = `<li style="padding:12px;border-bottom:1px solid #233766;color:#faa">debts listen error: ${escapeHTML(err.message||err)}</li>`;
        });

      } catch (e) {
        log("loadUserDataFlexible error:", e.code || e.message);
        alert("خطأ أثناء تحميل البيانات: " + (e.code || e.message));
      }
    }

    /* ===== مساعد صغير لمنع إدخال HTML في النصوص ===== */
    function escapeHTML(s){
      s = (s ?? "").toString();
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /* تشخيص سريع */
    log("origin:", location.origin, "\nauthDomain:", firebaseConfig.authDomain);
  </script>
</body>
</html>
